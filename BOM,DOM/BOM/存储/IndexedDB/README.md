# IndexedDB - Indexed Database

`IndexedDB`åœ¨å¾ˆä¹…ä»¥å‰å°±å·²ç»å­˜åœ¨äº†ï¼Œä½†ç”±äºå…¶è¾ƒä¸ºåº•å±‚å’Œå…¼å®¹æ€§é—®é¢˜ï¼Œæœ€è¿‘æ‰æ…¢æ…¢è¢«äººä»¬å¼€å§‹ä½¿ç”¨ã€‚ç›¸å½“äºå¸¸è§„çš„`Web Storage`æ¥è¯´ï¼Œå®ƒçš„å­˜å‚¨å®¹é‡æ›´å¤§(å‰è€…`5MB`)ä¸”å­˜å‚¨å’ŒæŸ¥è¯¢åŠŸèƒ½æ›´å®Œå–„ã€‚å®ƒæ˜¯ä¸€ä¸ªé¢å‘å¯¹è±¡æ•°æ®åº“ï¼Œä¸€ä¸ªæ•°æ®åº“ä¸­æ‰€æœ‰çš„æ•°æ®ä»¥å¯¹è±¡å­˜å‚¨ç©ºé—´çš„å½¢å¼å­˜åœ¨(å¸¸è§„çš„ä¸ºè¡¨)ï¼Œå¹¶ä¸”å®ƒå­˜å‚¨çš„æ•°æ®æ˜¯`Javascript`åŸç”Ÿç±»å‹æ•°æ®ï¼Œå¹¶ä¸”è¿˜å¯ä»¥å­˜å‚¨`Blob`ç±»å‹æ•°æ®ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå®ƒå¸¸è¢«ç”¨äºä¸€äº›ç¦»çº¿å­˜å‚¨æ¥ä½¿ç”¨ã€‚

> [`Indexed Database API 3.0`è‰æ¡ˆ](https://www.w3.org/TR/IndexedDB/#accessibility)å·²ç»å‘å¸ƒäº†

å¿«é€Ÿç›®å½•

-   [ä»æ§åˆ¶å°æŸ¥çœ‹æ•°æ®åº“](#ä»æ§åˆ¶å°æŸ¥çœ‹æ•°æ®åº“)
-   [è¿æ¥/åˆ›å»ºæ•°æ®åº“](#è¿æ¥åˆ›å»ºæ•°æ®åº“)
-   [å¯¹è±¡å­˜å‚¨ç©ºé—´](#å¯¹è±¡å­˜å‚¨ç©ºé—´)
-   [äº‹åŠ¡](#äº‹åŠ¡)
-   [å®é™…åº”ç”¨ä¸­çš„é—®é¢˜](#å®é™…åº”ç”¨ä¸­çš„é—®é¢˜)

## ä»æ§åˆ¶å°æŸ¥çœ‹æ•°æ®åº“

å½“æˆ‘ä»¬æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°çš„`Application - Storage(Chrome)/Storage(Firefox)`é€‰é¡¹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»å­˜å‚¨ç±»å‹ä¸­çœ‹åˆ°ä¸€ä¸ªåä¸º`IndexedDB`çš„é€‰é¡¹ã€‚ç‚¹å‡»åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç±»ä¼¼è¡¨æ ¼çš„æ•°æ®ä¿¡æ¯ï¼Œè¿™å°±æ˜¯`IndexedDB`ã€‚

> å½“æˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°çš„å¯¹åº”è¡¨æ ¼æ—¶ï¼ŒæŸ¥çœ‹çš„æ˜¯å½“æ—¶ç”Ÿæˆçš„ä¸€ä¸ªå¿«ç…§ã€‚`IndexedDB`æ˜¯æµè§ˆå™¨ä¸­ä¿å­˜ç»“æ„åŒ–æ•°æ®çš„ä¸€ç§æ•°æ®åº“ã€‚ï¼ˆä¸ºäº†å…¼å®¹æœ€å¥½ä½¿ç”¨æµè§ˆå™¨å‰ç¼€ï¼‰ã€‚ä»¥å‰ï¼Œ`IE10`ä¸­ä¸º`msIndexedDB`ï¼Œ`Firefox`ä¸­ä¸º`mozIndexedDB`ï¼Œ`Chrome`ä¸­ä¸º`webkitIndexedDB`

`IndexedDB`å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼Œæœ€å¤§ç‰¹è‰²æ˜¯ä½¿ç”¨**å¯¹è±¡**ä¿å­˜æ•°æ®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è¡¨æ¥ä¿å­˜ã€‚ä¸€ä¸ª`Indexed`æ•°æ®åº“å°±æ˜¯ä¸€ç»„ä½äºç›¸åŒå‘½åç©ºé—´ä¸‹çš„å¯¹è±¡çš„é›†åˆã€‚

> `IndexedDB`çš„å¤§å¤šæ•°æ“ä½œéƒ½æ˜¯**å¼‚æ­¥**çš„ï¼Œä¸€ä¸ªå¯¹æ•°æ®åº“çš„æ“ä½œå¯¹åº”ä¸€ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ç±»ä¼¼äº‹ä»¶è®¢é˜…çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®åº“æ“ä½œã€‚

æ¯ä¸ªæ•°æ®åº“éƒ½å…·æœ‰ä»¥ä¸‹çš„ä¿¡æ¯ï¼š

-   æ•°æ®åº“åç§°(`Database Name`)
-   æ•°æ®åº“å­˜å‚¨ç±»å‹(`Storage`)
-   æ•°æ®åº“æºå¤´(`Origin`)
-   æ•°æ®åº“ç‰ˆæœ¬(`Version`)
-   æ•°æ®åº“å­˜å‚¨ç©ºé—´é›†åˆ(`Object Stores`) â€” ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡å­˜å‚¨ç©ºé—´

å½“æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªæ•°æ®åº“æ—¶(å›¾ä¸­ä¸ºåä¸º`test`çš„æ•°æ®åº“)ï¼Œå…³äºè¿™ä¸ªæ•°æ®åº“çš„ä¿¡æ¯å°±ä¼šæ˜¾ç¤ºåœ¨å³ä¾§ï¼š

![selected a database](../imgs/database.png)

å½“æˆ‘ä»¬é€‰æ‹©å…·ä½“çš„å­˜å‚¨ç©ºé—´æ—¶(å›¾ä¸­ä¸º`keyname`çš„å­˜å‚¨ç©ºé—´)ï¼Œä¸€ä¸ªå¯¹è±¡å‘½åç©ºé—´ä¼šæœ‰å¦‚ä¸‹ä¿¡æ¯ï¼š

-   å¯¹è±¡å‘½åç©ºé—´åç§°(`Object Store Name`)
-   é”®å(`Key`) â€” å‘½åç©ºé—´çš„é”®åœ°å€(`keyPath`)
-   è‡ªåŠ¨é€’å¢(`Auto Increment`) â€” æ˜¯å¦å…è®¸é”®åè‡ªåŠ¨é€’å¢
-   ç´¢å¼•(`Indexes`) â€” å¯¹å¯¹è±¡ä»“åº“æŸä¸ªé”®å(`key`)çš„å­˜å‚¨çš„é›†åˆ

ä¸€ä¸ªå¯¹è±¡ä»“åº“å¦‚ä¸‹ä¸‹å›¾ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªåä¸º`keyPath`çš„å¯¹è±¡ä»“åº“

![a store](../imgs/a%20store.jpg)

å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç´¢å¼•æ—¶ï¼Œä¼šä»¥å½“å‰ç´¢å¼•çš„`key`æ¥ç®€å†ä¸€ä¸ªé›†åˆï¼Œä¸‹é¢ä¸ºåä¸º`keyPath`çš„å¯¹è±¡ä»“åº“åˆ›å»ºäº†ä¸€ä¸ªä»¥`x`ä¸ºé”®åçš„ç´¢å¼•ï¼š

![a index collection](../imgs/a%20index.jpg)

å¯¹æ¯”ä¸Šä¸‹å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ’é™¤äº†ä¸å…·æœ‰`x`å­—æ®µçš„é”®å€¼å¯¹ã€‚

## è¿æ¥/åˆ›å»ºæ•°æ®åº“

ä½¿ç”¨`IndexedDB`çš„ç¬¬ä¸€æ­¥æ˜¯æŠŠè¦æ‰“å¼€çš„æ•°æ®åº“åä¼ ç»™`indexedDB.open(name, version)`ï¼Œå¦‚æœä¼ å…¥çš„æ•°æ®åº“å·²ç»å­˜åœ¨ï¼Œå°±ä¼šå‘é€åº”è¯¥æ‰“å¼€å®ƒçš„è¯·æ±‚ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç‰ˆæœ¬å·(å¯é€‰ï¼Œç‰ˆæœ¬å·é»˜è®¤ä¸º`1`ï¼Œä¼ å…¥éæ•´æ•°ç‰ˆæœ¬å·æ—¶ï¼Œä¼šè½¬åŒ–ä¸ºæ•´æ•°)ï¼Œä¼ å…¥æ–°çš„ç‰ˆæœ¬å·æ˜¯ä¼šå‡çº§æ•°æ®åº“; å¦‚æœä¼ å…¥çš„æ•°æ®åº“ä¸å­˜åœ¨ï¼Œå°±ä¼šå‘é€ä¸€ä¸ª**åˆ›å»º**å¹¶æ‰“å¼€å®ƒçš„è¯·æ±‚ã€‚

æ€»ä¹‹ï¼Œè°ƒç”¨`indexedDB.open()`è¿”å›ä¸€ä¸ª`IDBRequest`å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªå¯¹è±¡ä¸Šå¯ä»¥æ·»åŠ `onerror`ï¼ˆæ‰“å¼€æ•°æ®åº“å¤±è´¥ï¼‰å’Œ`onsuccess`ï¼ˆæˆåŠŸæ‰“å¼€ï¼‰äº‹ä»¶å¤„ç†ç¨‹åºæ¥æŸ¥çœ‹æ˜¯å¦æ‰“å¼€æˆ–åˆ›å»ºæˆåŠŸã€‚(åŸºæœ¬ä¸Šæ‰€æœ‰çš„æ•°æ®åº“æ“ä½œéƒ½æ˜¯é€šè¿‡è¯·æ±‚æ¥è¿›è¡Œçš„ï¼Œè¿™ä¹Ÿå°±æ˜¯å¼‚æ­¥çš„åŸå› ï¼Œå¼‚æ­¥è¯·æ±‚çš„ç»“æœä¹ŸåŸºæœ¬ä¸Šä¼šå®šä¹‰åœ¨`event.target.result`ä¸Š)

```js
const indexedDB =
    window.indexedDB ||
    window.msIndexedDB ||
    window.mozIndexedDB ||
    window.webkitIndexedDB,
    request,
    database

// å‘æ•°æ®åº“å‘é€æ‰“å¼€çš„è¯·æ±‚
request = indexedDB.open('admin')

request.onerror = function ({
    target: {
        errorCode
    }
}) {
    console.log('å‘ç”Ÿäº†æ„å¤–')
}

request.onsuccess = function ({ target: { result } }) {
    // resultä¸ºè¿”å›çš„æ•°æ®åº“å¯¹è±¡
}
```

ä½¿ç”¨`success`äº‹ä»¶æ—¶ï¼Œ`event.target.result`ä¸­å°†æœ‰ä¸€ä¸ªæ•°æ®åº“å®ä¾‹å¯¹è±¡(`IDBDatabase`)ï¼Œ
`error`äº‹ä»¶æ—¶ï¼Œ`event.target.errorCode`ä¸­ä¿å­˜ç€ä¸€ä¸ªé”™è¯¯ç ï¼Œä»¥ä¸‹ä¸ºå¯èƒ½çš„é”™è¯¯ç ï¼š

-   `IDBDatabaseException.UNKNOWN_ERR(1)`ï¼šæ„å¤–é”™è¯¯ï¼Œæ— æ³•å½’ç±»
-   `IDBDatabaseException.NON_TRANSIENT_ERR(2)`ï¼šæ“ä½œä¸åˆæ³•
-   `IDBDatabaseException.NOT_FOUND_ERR(3)`ï¼šæœªå‘ç°è¦æ“ä½œçš„æ•°æ®åº“
-   `IDBDatabaseException.CONSTRAINT_ERR(4)`ï¼šè¿åäº†æ•°æ®åº“çº¦æŸ
-   `IDBDatabaseException.DATA_ERR(5)`ï¼šæä¾›ç»™å¤±è¯¯çš„æ•°æ®ä¸èƒ½æ»¡è¶³è¦æ±‚
-   `IDBDatabaseException.NOT_ALLOWED_ERR(6)`ï¼šæ“ä½œä¸åˆæ³•
-   `IDBDatabaseException.TRANSACTION_INACTIVE_ERR(7)`ï¼šè¯•å›¾é‡ç”¨å·²å®Œæˆçš„äº‹åŠ¡
-   `IDBDatabaseException.ABORT_ERR(8)`ï¼šè¯·æ±‚ä¸­æ–­ï¼ŒæœªæˆåŠŸ
-   `IDBDatabaseException.READ_ONLY_ERR(9)`ï¼šè¯•å›¾åœ¨åªè¯»æ¨¡å¼ä¸‹å†™å…¥æˆ–ä¿®æ”¹æ•°æ®
-   `IDBDatabaseException.TIMEOUT_ERR(10)`ï¼šåœ¨æœ‰æ•ˆæ—¶é—´å†…æœªå®Œæˆæ“ä½œ
-   `IDBDatabaseException.QUOTA_ERR(11)`ï¼šç£ç›˜ç©ºé—´ä¸è¶³

### æ•°æ®åº“ç‰ˆæœ¬å‡çº§

ä¸€ä¸ªæ•°æ®åº“çš„ç‰ˆæœ¬å°±å†³å®šäº†å½“å‰æ•°æ®åº“çš„ç»“æ„ï¼Œå³æ•°æ®åº“ä¸­å¯¹è±¡å­˜å‚¨ç©ºé—´åŠå…¶å†…éƒ¨ç»“æ„ã€‚

å½“è°ƒç”¨`indexedDB.open()`æ–¹æ³•ä¼ å…¥ç‰ˆæœ¬å·å¤§äºå½“å‰æ•°æ®åº“çš„ç‰ˆæœ¬å·å°±ä¼šè§¦å‘`upgradeneeded`äº‹ä»¶ï¼Œæˆ‘ä»¬**éœ€è¦(ä¹Ÿåªèƒ½)åœ¨è¯¥äº‹ä»¶ä¸­å†³å®šæ•°æ®åº“çš„ç»“æ„**ã€‚

```js
request.onupgradeneeded = function ({ target: { result: database } }) {
    // ç°åœ¨ä½ å¯ä»¥åˆ›å»ºè¯¥æ•°æ®åº“çš„å¯¹è±¡å­˜å‚¨ç©ºé—´å’Œç´¢å¼•

    // åˆ›å»ºäº†ä¸€ä¸ªåä¸ºnameçš„å¯¹è±¡å­˜å‚¨ç©ºé—´
    const store = database.createObjectStore('name')

    // åˆä¸ºè¯¥storeåˆ›å»ºäº†ä¸€ä¸ªåä¸ºaçš„ç´¢å¼•
    store.createIndex('a', 'x')
}
```

åœ¨æŸæ¬¡æ•°æ®åº“å‡è¿äº‹ä»¶ä¸­ï¼Œéƒ½ä¼š**ä¿ç•™**è€ç‰ˆæœ¬çš„åŸæœ‰å¯¹è±¡å­˜å‚¨ç©ºé—´(`Store`)ã€‚æ‰€ä»¥å¦‚æœä½ è¦å˜åŠ¨(æŒ‡å¯¹å…¶é…ç½®çš„å˜åŠ¨ï¼Œæ¯”å¦‚æ”¹å˜å…¶`keyPath`)åŸæœ‰å¯¹è±¡å­˜å‚¨ç©ºé—´ï¼Œé‚£ä¹ˆä½ éœ€è¦å…ˆå°†åŸæœ‰ç©ºé—´åˆ é™¤ç„¶ååœ¨è¿›è¡Œåˆ›å»ºã€‚(å½“ç„¶ä½ éœ€è¦è‡ªè¡Œå¤„ç†é‡Œé¢çš„æ•°æ®)

> è¿™åŒæ—¶è¯´æ˜äº†ä½ ä¸èƒ½åˆ›å»ºåŒåçš„å¯¹è±¡å­˜å‚¨ç©ºé—´ï¼Œæ²¡å…³ç³»ä½ å¯ä»¥é€šè¿‡`IDBDatabase.objectStoreNames`æ¥è·å–å½“å‰æ•°æ®åº“ä¸Šå…¨éƒ¨å­˜åœ¨çš„å¯¹è±¡å­˜å‚¨ç©ºé—´åç§°ï¼Œå®ƒæ˜¯ä¸€ä¸ªç±»æ•°ç»„å¯¹è±¡

å½“`upgradeneeded`äº‹ä»¶æ‰§è¡ŒæˆåŠŸåï¼Œæ‰ä¼šæ‰§è¡Œ`success`æ—¶é—´ï¼Œæ‰€ä»¥ä½ ä¸ç”¨æ‹…å¿ƒå®ƒä»¬çš„å…ˆåé¡ºåºã€‚

## å¯¹è±¡å­˜å‚¨ç©ºé—´

åœ¨`indexedDB`ä¸­ä½¿ç”¨å¯¹è±¡å­˜å‚¨ç©ºé—´(`Store`)è€Œä¸æ˜¯è¡¨æ¥å­˜å‚¨æ•°æ®ã€‚ä¸€ä¸ªæ•°æ®åº“å¯ä»¥åŒ…å«ä»»æ„æ•°é‡çš„å¯¹è±¡å­˜å‚¨ç©ºé—´(ä½“ç§¯å¤§äº`50MB`æ—¶éœ€è¦å‘ç”¨æˆ·ç”³è¯·æƒé™)

### åˆ›å»ºå¯¹è±¡å­˜å‚¨ç©ºé—´

æˆ‘ä»¬å¯ä»¥é€šè¿‡`IDBDatabase.createObjectStore()`æ¥åˆ›å»ºå¯¹è±¡å­˜å‚¨ç©ºé—´ã€‚æ¯å½“ä¸€ä¸ªå€¼è¢«å­˜å…¥å¯¹è±¡å­˜å‚¨ç©ºé—´æ—¶ï¼Œå…¶ä¼šä¸ä¸€ä¸ª`key`å…³è”ï¼Œè¿™ä¸ª`key`æ ¹æ®å¯¹è±¡å­˜å‚¨ç©ºé—´çš„åˆ›å»ºæ¨¡å¼ä¸åŒï¼Œå…·æœ‰ä¸åŒçš„å½¢å¼ã€‚

åœ¨æˆ‘ä»¬åˆ›å»ºå¯¹è±¡å­˜å‚¨ç©ºé—´æ—¶ï¼Œæ”¯æŒä¼ å…¥ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼š

```js
database.createObjectStore(name, { keyPath?, autoIncrement? })
```

è¿™ä¸ªé…ç½®å¯¹è±¡å¯ä»¥æ”¯æŒä¸¤ä¸ªå­—æ®µï¼Œç¬¬ä¸€ä¸ªä¸º`keyPath`ï¼Œå®ƒè¡¨ç¤ºå½“å‰å¯¹è±¡ä»“åº“çš„ä¸»é”®(å®˜ç½‘ç§°å‘¼ä¸ºå†…é”®, `in-line key`)ï¼Œå¯ä»¥ä¸ºä¸€ä¸ªæ•°ç»„ã€‚å¦‚æœä½ **ä¸æŒ‡å®š**è¯¥å‚æ•°åˆ™å½“å‰å¯¹è±¡å­˜å‚¨ç©ºé—´ä½¿ç”¨å¤–é”®(`out of line key`)ä¸ºä½œä¸º`key`ã€‚å½“å…¶ä¸ºå¤–é”®æ—¶ï¼Œä½ å¯ä»¥å°†å…¶ç†è§£ä¸ºå¯¹è±¡çš„é”®å€¼å¯¹ã€‚

```js
// #1
const store = database.createObjectStore('my-idb')

// å­˜å…¥ä¸€ä¸ªé”®åä¸ºaï¼Œå€¼ä¸º1
store.add(1, 'a')

// æŠ¥é”™ï¼Œå¤–é”®ç±»å‹å†™å…¥å¿…é¡»æŒ‡å®škey
store.add(1)
```

å½“æˆ‘ä»¬æŒ‡å®šäº†`keyPath`æ—¶ï¼Œå¿…é¡»å­˜å…¥å¯¹è±¡ï¼Œä¸”è¯¥å¯¹è±¡å¿…é¡»è¦æœ‰å¯¹åº”`keyPath`çš„é”®åï¼Œå…¶å€¼ä¹Ÿä¸èƒ½é‡å¤ã€‚(æ­¤æ—¶æˆ‘ä»¬å­˜å…¥å€¼æ—¶ä¸éœ€è¦æŒ‡å®šé”®åï¼ŒæŒ‡å®šäº†ä¹Ÿé»˜è®¤ä¸ç”Ÿæ•ˆ)

```js
// #2
// åˆ›å»ºä¸€ä¸ªå¯¹è±¡å­˜å‚¨ç©ºé—´ï¼ŒæŒ‡å®šxä¸ºä¸»é”®
const store = database.createObjectStore('my-idb', { keyPath: 'x' })

// é‚£ä¹ˆæˆ‘ä»¬å­˜å‚¨æ—¶ï¼Œåªèƒ½å­˜å…¥å¯¹è±¡ï¼Œä¸”å¿…é¡»åŒ…å«xè¿™ä¸ªé”®åï¼Œæ¯ä¸ªxçš„é”®å€¼ä¹Ÿä¸èƒ½é‡å¤
store.add({ x: 1, y: 2 })

// æŠ¥é”™ï¼Œä¸»é”®å€¼é‡å¤
store.add({ x: 1, y: 3 })
```

æŒ‡å®šå¤šä¸ªä¸»é”®`keyPath`æ—¶ï¼Œå¿…é¡»æ¯ä¸€ä¸ªéƒ½ä¼ å…¥å€¼ã€‚

```js
// #3
const store = database.createObjectStore('my-idb', { keyPath: ['x', 'y'] })

store.add({ x: 1, y: 1 })

// ç”±äºä¸»é”®yæœªç”Ÿæˆå€¼ï¼Œæ‰€ä»¥æŠ¥é”™
store.add({ x: 1, b: 2 })
```

å¦ä¸€ä¸ªå‚æ•°ä¸º`autoIncrement`ï¼Œå®ƒè¡¨ç¤ºè‡ªåŠ¨ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ç§æœ‰åºé”®å€¼ã€‚å¦‚æœä¸æŒ‡å®šè¯¥å±æ€§ï¼Œé‚£ä¹ˆä½ åœ¨å‘å¯¹è±¡å­˜å‚¨ç©ºé—´å­˜å…¥æ•°æ®æ—¶å¿…é¡»è¦æŒ‡å®šé”®å`key`(ä¸Šé¢çš„ä¾‹å­éƒ½è¯´æ˜äº†)ã€‚

```js
// #4
const store = database.createObjectStore('my-idb', { autoIncrement: true })

store.add(1)

// ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºé”®ç”Ÿæˆå™¨ç”Ÿæˆä¸åŒçš„ä¸»é”®å€¼äº†
store.add(1)
store.add({ b: 1 })
```

ä¸Šé¢çš„ä»£ç çš„æ•ˆæœå¦‚ä¸‹ï¼š

![auto-increment-key](./../imgs/auto-key.jpg)

åŒç†ï¼Œåœ¨åŒæ—¶æŒ‡å®š`keyPath`æ—¶ï¼Œå…¶ä¹Ÿå¯ä»¥ä¸ç”¨æŒ‡å®šå…¶é”®å€¼ï¼Œå…¶ä¼šæŒ‰æœ‰åºæ•°åˆ—è‡ªåŠ¨ç”Ÿæˆã€‚

```js
const store = database.createObjectStore('my-idb', {
    keyPath: 'x',
    autoIncrement: true
})

// ç”Ÿæˆ x: 1
store.add({ a: 1 })

// ç”Ÿæˆ  x: 3
store.add({ x: 3 })

// ç”Ÿæˆ x: 4
store.add({ a: 1 })
```

å®é™…æ•ˆæœå¦‚ä¸‹å›¾:

![auto-with-path](../imgs/auto-key-with-key-path.jpg)

æ³¨æ„æ¯æ¬¡è‡ªåŠ¨ç”Ÿæˆé”®å€¼æ—¶ï¼Œå…¶ä¼šå–**æœ€åå­˜å…¥çš„æœ‰åºæ•°å€¼**çš„å€¼åŠ `1`æ¥æ–°ç”Ÿäº§æ–°çš„é”®å€¼ã€‚æ‰€ä»¥æˆ‘æ¨èå¦‚æœä½¿ç”¨`autoIncrement`å±æ€§æ—¶ï¼Œå¯¹äºè¦æŒ‡å®šå…¶å€¼çš„`keyPath`ï¼Œè‡ªå§‹è‡³ç»ˆéƒ½ä¸ºå…¶æŒ‡å®šå€¼ï¼Œä¸è¦è®©å…¶è‡ªåŠ¨ç”Ÿæˆï¼Œå¦åˆ™å¯èƒ½ä¼šäº§ç”Ÿé”®å€¼å†²çªã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒæŒ‰ç…§ä¸åŒçš„é…ç½®äº§ç”Ÿäº†å¦‚ä¸‹çš„æ•ˆæœ:
keyPath|autoIncrement|æè¿°
:-:|:-:|:-:
ä¸ä½¿ç”¨|ä¸ä½¿ç”¨|å¯ä»¥æ·»åŠ **ä»»æ„ç±»å‹**çš„å€¼ï¼Œä½†å¿…é¡»æŒ‡å®š`key`ï¼Œä¸”`key`å¿…é¡»ä¸åŒï¼Œå¯ä»¥ç†è§£ä¸º**å‘å¯¹è±¡æ·»åŠ é”®å€¼å¯¹**ã€‚
ä½¿ç”¨|ä¸ä½¿ç”¨|**åªèƒ½æ·»åŠ å¯¹è±¡ç±»å‹å€¼**ï¼Œä¸”å¯¹è±¡å¿…é¡»å…·æœ‰æŒ‡å®š`keyPath`çš„å€¼ï¼Œä¸”ä¸èƒ½é‡å¤
ä¸ä½¿ç”¨|ä½¿ç”¨|å¯ä»¥æ·»åŠ **ä»»æ„ç±»å‹**çš„å€¼ï¼Œä¸”ä¸ç”¨æŒ‡å®š`key`ï¼Œå¯ä»¥ç†è§£ä¸º**å‘æ•°ç»„æ·»åŠ å…ƒç´ **ã€‚
ä½¿ç”¨|ä½¿ç”¨|**åªèƒ½æ·»åŠ å¯¹è±¡ç±»å‹å€¼**ï¼Œå¯ä»¥ä¸ç”¨æŒ‡å®š`keyPath`ä¸­å­—æ®µçš„å€¼ã€‚(å»ºè®®æŒ‡å®šæ—¶è¡Œä¸ºç»Ÿä¸€)

ç°åœ¨æˆ‘ä»¬æš‚æ—¶ä¸å…³æ³¨å¦‚ä½•å»å‘å¯¹è±¡å­˜å‚¨ç©ºé—´æ’å…¥æ•°æ®ï¼Œå…ˆæ ¹æ®é¡ºåºæ¥æŸ¥çœ‹å…¶äº‹åŠ¡ï¼Œå› ä¸ºæ•°æ®è¯»å†™åŸºäºäº‹åŠ¡æ“ä½œã€‚

## äº‹åŠ¡

åœ¨æ•°æ®åº“å¯¹è±¡ä¸Šè°ƒç”¨`database.transaction()`æ–¹æ³•å¯ä»¥åˆ›å»ºäº‹åŠ¡ã€‚**ä»»ä½•æ—¶å€™æƒ³è¦è¯»å–æˆ–ä¿®æ”¹æ•°æ®ï¼Œéƒ½è¦é€šè¿‡äº‹åŠ¡æ¥ç»„ç»‡æ‰€æœ‰æ“ä½œ**ã€‚

ä½¿ç”¨è¯¥æ–¹æ³•æ—¶å¿…é¡»æŒ‡å®šæ“ä½œçš„å‘½åç©ºé—´çš„åç§°(å¯ä»¥ç”¨æ•°ç»„æŒ‡å®šå¤šä¸ª)ï¼Œè¿˜å¯æŒ‡å®šæ“ä½œæ¨¡å¼(åªè¯»`readonly`æˆ–è¯»å†™`readwrite`)ã€‚è°ƒç”¨åä¼šè¿”å›ä¸€ä¸ªäº‹åŠ¡å¯¹è±¡(`IDBTransaction`)ã€‚

> å®é™…ä¸Šè¯¥å‡½æ•°è¿˜æœ‰ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç”¨äºæƒè¡¡æ•°æ®åº“æ“ä½œçš„è´¨é‡ä¸é€Ÿåº¦ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒ[IDBDatabase.transaction()
> ](https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/transaction)

ä¸‹é¢åˆ›å»ºä¸€ä¸ªäº‹åŠ¡

```js
// æŒ‡å®šåä¸ºusersçš„å­˜å‚¨ç©ºé—´çš„è¯»å†™äº‹åŠ¡
const dbTransaction = database.transaction('users', 'readwrite')
```

å®é™…ç»“æœä¸º:

![IDBTransaction](../imgs/IDBTransaction.png)

ä¸Šè¿°ä¿¡æ¯ä½ éƒ½ä¸éœ€è¦å»äº†è§£ï¼Œå› ä¸ºä¸å¤ªé‡è¦ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨è¯¥å¯¹è±¡ä¸Šçš„`IDBTransaction.objectStore()`æ–¹æ³•ã€‚å®ƒç”¨äºè®¿é—®å½“å‰äº‹åŠ¡æ“ä½œä¸­çš„å¯¹è±¡å­˜å‚¨ç©ºé—´ï¼Œè°ƒç”¨åä¼šè¿”å›å¯¹åº”çš„å¯¹è±¡å­˜å‚¨ç©ºé—´(`IDBObjectStore`)ã€‚

```js
// è·å–åˆ°usersçš„å¯¹è±¡å­˜å‚¨ç©ºé—´
const store = dbTransaction.objectStore('users')
```

### å‘å¯¹è±¡å­˜å‚¨ç©ºé—´æ’å…¥/åˆ é™¤/æ›´æ–°æ•°æ®

å½“æˆ‘ä»¬é€šè¿‡äº‹åŠ¡æ“ä½œè·å–åˆ°æƒ³è¦æ“ä½œçš„å¯¹è±¡å­˜å‚¨ç©ºé—´æ—¶ï¼Œå°±å¯ä»¥å‘å…¶å†™å…¥æ•°æ®ã€‚

å†™å…¥æ•°æ®éœ€è°ƒç”¨`IDBObjectStore.add()`æˆ–`IDBObjectStore.put()`æ–¹æ³•ï¼Œä¸¤è€…çš„åŒºåˆ«å°±æ˜¯åè€…ä¼šåœ¨å†™å…¥å·²å­˜åœ¨é”®å€¼æ—¶ï¼Œé‡æ–°å…¶æ•°æ®ï¼Œè€Œä¸æ˜¯æŠ¥é”™ã€‚(æ‰€ä»¥å®Œå…¨ç”¨`put()`ä»£æ›¿`add()`)

ä¸¤è€…çš„å‚æ•°éƒ½ä¸€è‡´ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºå†™å…¥çš„å€¼ï¼Œç¬¬äºŒä¸ªä¸ºå†™å…¥çš„é”®å(å¯é€‰ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨å†™å…¥è‡ªç”Ÿæˆé”®å€¼æ—¶å°±ä¸ç”¨æŒ‡å®šäº†)ã€‚

```js
const request = store.add({
    username: '007',
    firstName: 'James',
    password: 'foo'
})
```

åŒæ‰“å¼€æ•°æ®åº“ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œäº‹ä»¶è®¢é˜…æ¥æŸ¥çœ‹æ­¤æ¬¡å†™å…¥æ˜¯å¦æˆåŠŸ(å…·ä½“çš„å†™å…¥æ—¶è§„åˆ™ä¹‹å‰è¯¦ç»†è¯´æ˜è¿‡ï¼Œ[ç‚¹å‡»è·³è½¬](#åˆ›å»ºå¯¹è±¡å­˜å‚¨ç©ºé—´)):

```js
request.onsuccess = () => {}
request.onerror = () => {}
```

å½“ä½ æƒ³åˆ é™¤ä¸€ä¸ªé”®å€¼æ—¶ï¼Œå¯ä»¥é€šè¿‡`IDBObjectStore.delete()`æ–¹æ³•ï¼Œå…¶ä¼šåˆ æ‰æŒ‡å®šçš„ä¸€ä¸ªé”®å€¼(æˆ–é”®åï¼Œå…·ä½“çœ‹èµ·æ˜¯å¦æŒ‡å®š`keyPath`ï¼ŒæŒ‡å®šæ—¶ä¸ºå…¶é”®å€¼ï¼ŒæœªæŒ‡å®šæ—¶åˆ™ä¸ºé”®å)æˆ–é”®å€¼èŒƒå›´(`keyRange`ï¼Œç­‰ä¼šä¼šè®²åˆ°)

```js
// åˆ›å»ºä¸¤ä¸ªkeyPathçš„store
const store = db.createObjectStore('my-store', { keyPath: ['x', 'y'] })

// çœç•¥æ“ä½œäº‹åŠ¡è®¿é—®å­˜å‚¨ç©ºé—´æ­¥éª¤
// å†™å…¥æ•°æ®
store.add({ x: 1, y: 2 })

// å‡è®¾è¡Œä¸ºæ˜¯åŒæ­¥çš„
// åˆ é™¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŒ‰keyPathé¡ºåºåŠ å€¼æ¥åˆ é™¤ï¼Œå°±åƒè·¯å¾„ä¸€æ ·
store.delete([1, 2]) // æ­¤æ—¶å°±åˆ é™¤äº†ä¸Šè¿°å€¼

// åŒç†
store.add({ x: 'x', y: 'y' })
store.delete(['x', 'y']) // åˆ é™¤æˆåŠŸ
```

åˆ é™¤ä¸€ä¸ªæœªæŒ‡å®š`keyPath`çš„æ•°æ®åªéœ€è¦æŒ‡å®šå…¶`key`å³å¯ï¼Œå°±åƒåˆ é™¤å¯¹è±¡çš„æŸä¸ªé”®ä¸€æ ·ã€‚(**æ³¨æ„åˆ é™¤å…·æœ‰å¤šä¸ª`keyPath`çš„å€¼æ—¶ï¼Œéœ€è¦æŒ‡å®šæ¯ä¸ª`keyPath`çš„å€¼**)

```js
const store = db.createObjectStore('my-store')

// çœç•¥æ“ä½œäº‹åŠ¡è®¿é—®å­˜å‚¨ç©ºé—´æ­¥éª¤
// å†™å…¥æ•°æ®
store.add({ x: 1, y: 2 }, 'x')

// åˆ é™¤æˆåŠŸ
store.delete('x')
```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨`IDBObjectStore.clear()`æ¸…ç©ºå½“å‰å¯¹è±¡å­˜å‚¨ç©ºé—´ã€‚

[MDN IDBObjectStore](https://developer.mozilla.org/zh-CN/docs/Web/API/IDBObjectStore#delete)

### è¯»å–å¯¹è±¡å­˜å‚¨ç©ºé—´çš„æ•°æ®

è¯»å–æ“ä½œç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬è¦è·å–å…¶è¯»å–çš„ç»“æœï¼ŒåŒæ ·çš„å…¶è°ƒç”¨`IDBObjectStore .get()`æ–¹æ³•æ¥è¯»å–æ•°æ®ï¼Œç”¨æ³•å’Œ`IDBObjectStore.delete()`ä¸€æ ·(è¯´æ˜å°±åœ¨ä¸Šé¢ä¸€ç‚¹ç‚¹ï¼Œæˆ‘è¿™é‡Œå°±ä¸é‡å¤äº†)

```js
database.createObjectStore('users', { keyPath: 'x' })
const store = database.transaction('users').objectStore('users')

// å‡è®¾ä¸ºåŒæ­¥æ“ä½œ
store.add({ x: 1, y: 2 })

const request = store.get(1)
request.onsuccess = ({ result }) => {
    // resultä¸Šä¸ºæŸ¥è¯¢åˆ°çš„æ•°æ®
}
```

#### é€šè¿‡ç´¢å¼•(Index)æŸ¥æ‰¾

é™¤äº†ç›´æ¥é€šè¿‡é”®æŸ¥æ‰¾å¤–ï¼Œå¯¹è±¡å­˜å‚¨ç©ºé—´è¿˜å¯ä»¥é€šè¿‡ç´¢å¼•æ¥è¿›è¡ŒæŸ¥æ‰¾ã€‚

åœ¨æŸ¥æ‰¾ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨**æ•°æ®åº“ç‰ˆæœ¬å‡è¿é˜¶æ®µ**å°±ä¸ºå…¶åˆ›å»ºå¥½å¯¹åº”çš„ç´¢å¼•ï¼Œæ­¤æ—¶æˆ‘ä»¬æ‰å¯ä»¥åœ¨äº‹åŠ¡æ“ä½œä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚

```js
request.onupgradeneeded = function ({ target: { result: database } }) {
    // ç°åœ¨ä½ å¯ä»¥åˆ›å»ºè¯¥æ•°æ®åº“çš„å¯¹è±¡å­˜å‚¨ç©ºé—´å’Œç´¢å¼•

    // åˆ›å»ºäº†ä¸€ä¸ªåä¸ºusersçš„å¯¹è±¡å­˜å‚¨ç©ºé—´
    const store = database.createObjectStore('users')

    // åˆä¸ºè¯¥storeåˆ›å»ºäº†ä¸€ä¸ªåä¸ºmy-indexçš„ç´¢å¼•ï¼Œå½“å‰ç´¢å¼•ä¼šæ”¶é›†é”®å(å¯¹è±¡æ—¶ä¸ºé”®å€¼)ä¸ºxçš„æ•°æ®
    store.createIndex('my-index', 'x')
}
```

ä¸Šè¿°ä»£ç é€šè¿‡ï¼Œ`IDBObjectStore.createIndex(name, indexName, { unique?, multiEntry? })`åˆ›å»ºäº†ä¸€ä¸ªåä¸º`my-index`çš„ç´¢å¼•ï¼Œè¯¥å‡½æ•°å¯ä»¥ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºåˆ›å»ºçš„ç´¢å¼•åç§°ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºæ”¶é›†çš„æ•°æ®çš„é”®å(æŒ‡å®š`keyPath`æ—¶åˆ™ä¸ºå…¶`keyPath`çš„é”®å€¼ï¼Œå¯ä»¥ä¸ºæ•°ç»„)ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºä¸€ä¸ªå¯é€‰çš„é…ç½®å¯¹è±¡ï¼Œå…¶ä¸­`unique`è¡¨ç¤ºæ˜¯å¦å…è®¸æ”¶é›†çš„é”®å€¼é‡å¤ï¼›`multiEntry`è¡¨ç¤ºå½“æˆ‘ä»¬æŒ‡å®šçš„`keyPath`ä¸ºä¸€ä¸ªæ•°ç»„æ—¶ï¼Œæ˜¯å¦ä¸ºå…¶æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½åˆ›å»ºä¸€æ¡ç´¢å¼•æ•°æ®ã€‚

[MDN IDBIndex](https://developer.mozilla.org/en-US/docs/Web/API/IDBIndex/multiEntry)
[IndexedDB: MultiEntry Explained](https://dzone.com/articles/indexeddb-multientry-explained)

åˆ›å»ºåè¿”å›ä¸€ä¸ª`IDBIndex`å¯¹è±¡ï¼Œç»“æ„å¦‚ä¸‹ï¼Œå°±åŒ…å«ä¸€äº›åˆ›å»ºæ—¶çš„ä¿¡æ¯:

![create a index](../imgs/create%20a%20index.jpg)

ç°åœ¨æ ¹æ®ä¸Šé¢çš„ç´¢å¼•ï¼Œæˆ‘ä»¬æ’å…¥ä¸¤æ¡æ•°æ®ï¼š

```js
// çœç•¥äº†æ“ä½œäº‹åŠ¡çš„è¿‡ç¨‹
store.add(
    {
        x: 1,
        y: 2,
        a: 3
    },
    'x'
)
store.add(1, 'y')
```

é‚£ä¹ˆåœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­å¯ä»¥çœ‹åˆ°è¿™æ ·çš„æ•ˆæœï¼š

![my-index's store](../imgs/my-index's%20store.png)
![my-index](../imgs/my-index.jpg)

ä¸‹é¢æˆ‘ç”¨ä¸€ä¸ªä¾‹å­æ¥è§£é‡Š`multiEntry`(`unique`å°±ä¸ç”¨è§£é‡Šäº†ï¼Œå°±æ˜¯æ˜¯å¦å…è®¸ç´¢å¼•å­—æ®µå€¼é‡å¤):

```js
// å‡è®¾åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹çš„store
const store = database.createObjectStore('xxx', { keyPath: 'x' })

// æŒ‡å®šå…¶æœ‰å¤šå…¥å£
store.createIndex('my-index', 'x', { multiEntry: true })

// éšåæˆ‘ä»¬åœ¨äº‹åŠ¡ä¸­æ’å…¥è¿™æ ·ä¸¤æ¡æ•°æ®
store.add({
    x: [1, 2, 3],
    y: 2,
    a: 3
})
store.add({
    x: 2,
    y: 3,
    a: 4
})
```

é‚£ä¹ˆä¸Šè¿°ä»£ç ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ç´¢å¼•æ•°æ®

![use multiEntry](../imgs/use%20multiEntry.png)

è‹¥æˆ‘ä»¬ä¸æŒ‡å®š`multiEntry`é‚£ä¹ˆå®ƒäº§ç”Ÿçš„ç´¢å¼•æ•°æ®ä¸º:

![use no multiEntry](../imgs/use%20no%20multiEntry.png)

å¯ä»¥çœ‹åˆ°å…¶ç›¸å¯¹äºè§£æ„äº†`keyPath`ä¸ºæ•°ç»„çš„å€¼ã€‚

å½“ç„¶æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªå°†ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸ºåŒ…å«å¤šä¸ªé”®åçš„æ•°ç»„:

```js
// å‡è®¾åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹çš„store
const store = database.createObjectStore('xxx', { keyPath: 'x' })

// æŒ‡å®šå…¶æœ‰å¤šå…¥å£
store.createIndex('my-index', ['y', 'z'])

// éšåæˆ‘ä»¬åœ¨äº‹åŠ¡ä¸­æ’å…¥è¿™æ ·ä¸¤æ¡æ•°æ®
store.add({
    x: [1, 2, 3],
    y: 2,
    z: 3
})
store.add({
    x: 2,
    y: 3,
    z: 4
})
```

é‚£ä¹ˆå…¶ä¼šå°†äº§ç”Ÿä»¥ä¸‹æ•ˆæœ:

![multiKey index](../imgs/multiKey%20index.png)

æ³¨æ„æ­¤æ—¶ä¸èƒ½æŒ‡å®š`multiEntry`å±æ€§ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œæ•°ç»„å½¢å¼çš„ç´¢å¼•`key`ä¸èƒ½ä¸å…¶å…±åŒä½¿ç”¨ã€‚(ä¸ç„¶å°±å¤„ç†èµ·æ¥å°±å¤æ‚äº†)

å’³å’³ï¼Œç»ˆäºè¿›å…¥æ­£é¢˜äº†ï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨åˆ›å»ºçš„ç´¢å¼•æ¥æŸ¥æ‰¾æ•°æ®ã€‚ç”±äºæˆ‘ä»¬åŸºæœ¬ä¸Šä¸ä¼šåœ¨æ•°æ®åº“å‡è¿äº‹ä»¶ä¸­æ¥æŸ¥æ‰¾æ•°æ®
ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æˆ‘ä»¬åœ¨ä¹‹å‰åˆ›å»ºçš„ç´¢å¼•ï¼š`IDBObjectStore.index()`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºè¦æŸ¥æ‰¾çš„ç´¢å¼•çš„åç§°ï¼Œè¿”å›ä¸€ä¸ª`IDBIndex`ç´¢å¼•å¯¹è±¡ã€‚

> æ¥ä¸‹æ¥çš„ä¾‹å­éƒ½ä»¥ä¸‹å›¾çš„ç´¢å¼•ç»“æœè¿›è¡Œ
> ![a snapshot of index](../imgs/a%20snapshot%20of%20index.png)

æ‰¾åˆ°æˆ‘ä»¬çš„ç´¢å¼•å¯¹è±¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å½“å‰çš„`IDBIndex`ç´¢å¼•å¯¹è±¡è®¿é—®å™¨ä¸Šé¢çš„æ•°æ®äº†ã€‚å¯¹äº`IDBIndex`çš„æ“ä½œçš„ç»“æœéƒ½æ˜¯é€šè¿‡`IDBRequest`è¯·æ±‚çš„æ–¹å¼è¿”å›ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨äº‹ä»¶ä¸­å»è®¢é˜…å®ƒçš„ç»“æœã€‚

```js
// çœç•¥é€šè¿‡äº‹åŠ¡è·å–å¯¹è±¡å­˜å‚¨ç©ºé—´çš„æ“ä½œ
const index = store.index('my-index')

// è·å–å½“å‰ç´¢å¼•ä¸­æ‰€æœ‰æ•°æ®çš„æ•°ç›®
const request = index.count()

// è¿”å›çš„äº‹ä»¶å¯¹è±¡.target.resultå°±ä¸ºç»“æœ
request.onsuccess = ({ target: { result } }) => result // result ä¸º 2
```

ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬æ²¡æœ‰å¿…è¦å»æŸ¥è¯¢ç´¢å¼•çš„æ•°æ®æ•°é‡ï¼Œå¦‚æœéœ€è¦éå†æˆ‘ä»¬ç›´æ¥è°ƒç”¨`IDBIndex.getAll()`æ‹‰å–æ‰€æœ‰çš„æ•°æ®æ¥è¿›è¡Œéå†

```js
// è·å–å½“å‰ç´¢å¼•ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„
const request = index.getAll()

request.onsuccess = ({ target: { result } }) => result
```

ä¸Šè¿°çš„ç»“æœå¦‚å›¾ï¼š

![index getAll](../imgs/index%20getAll.png)

æˆ‘ä»¬è¿˜å¯ä»¥ä¸º`IDBIndex.getAll()`è®¾ç½®æŸ¥è¯¢çš„æ¡ä»¶å’Œæ•°ç›®ä¸Šé™ï¼Œå®ƒå¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºå½“å‰æŸ¥è¯¢`key`çš„å€¼(è¿™ä¸ª`key`å€¼å³ä¸ºç´¢å¼•çš„`key`çš„å€¼)ï¼›ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæŸ¥è¯¢çš„æ•°æ®æ¡æ•°ï¼Œè¶…è¿‡æ—¶çœç•¥ã€‚

```js
// æŸ¥è¯¢keyPathä¸º1çš„æ‰€æœ‰æ•°æ®
const request = index.getAll(2)

request.onsuccess = ({ target: { result } }) => result // ç»“æœä¸º[{ x: 2, y: 3, z: 4 }]ï¼Œå³ä¸Šå›¾çš„ç¬¬2æ¡æ•°æ®
```

å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡`IDBIndex.get()`æ¥æŸ¥æ‰¾å¯¹åº”çš„æŸä¸ªè®°å½• ğŸ“ çš„å€¼ï¼Œåªéœ€è¦ä¼ å…¥å½“å‰ç´¢å¼•é”®åçš„å€¼å³å¯(å…·æœ‰å¤šæ¡åŒå€¼æ•°æ®æ—¶è¿”å›ç¬¬ä¸€æ¡)ï¼š

```js
// æŸ¥æ‰¾ç´¢å¼•ä¸ºy: 2, z: 3çš„æ•°æ®
const request = index.get([2, 3])

request.onsuccess = ({ target: { result } }) => result
```

æ­¤æ—¶è¿”å›çš„ç»“æœä¸º

![find a key](../imgs/find%20a%20key.jpg)

é™¤æ­¤ä¹‹å¤–ä½ è¿˜å¯ä»¥é€šè¿‡`IDBIndex.getKey()`æ¥è·å–å¯¹åº”ç´¢å¼•å€¼çš„`keyPath`å€¼ï¼š

```js
// çœç•¥ä¹‹å‰çš„äº‹åŠ¡æ“ä½œå’Œä¹‹åçš„äº‹ä»¶è®¢é˜…æ“ä½œ
index.getKey([2, 3]) // [1, 2, 3]
```

æˆ–è€…ä½ å¯ä»¥ä¸€å£æ°”è·å–å…¨éƒ¨ç´¢å¼•æ•°æ®çš„`keyPath`å€¼é›†åˆï¼š

```js
index.getAllKeys()
```

ç»“æœå¦‚ä¸‹ï¼š

![get all keys](../imgs/getAllKeys.jpg)

å½“ç„¶`IDBIndex.getAllKeys()`è¿˜å¯ä»¥ä¼ å…¥æŸ¥è¯¢çš„æ¡ä»¶ï¼Œè¿™é‡Œå°±ä¸å¤šæäº†ï¼Œè‡ªè¡Œäº†è§£

[MDN IDBIndex.getAllKeys()](https://developer.mozilla.org/en-US/docs/Web/API/IDBIndex/getAllKeys)

#### é€šè¿‡æ¸¸æ ‡æŒ‡é’ˆ(Cursor)æŸ¥æ‰¾

é™¤äº†é€šè¿‡ç´¢å¼•æ¥æŸ¥è¯¢æ•°æ®ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ¸¸æ ‡æŒ‡é’ˆæ¥æŸ¥è¯¢æ•°æ®ï¼Œæ¯•ç«Ÿæˆ‘ä»¬ä¸æ˜¯æ‰€æœ‰æ•°æ®éƒ½é€šè¿‡ç´¢å¼•è¿›è¡Œç®¡ç†ï¼Œå¯èƒ½è¿˜æœ‰ä¸€äº›å…¶ä»–æ•°æ®éœ€è¦æ¥æŸ¥æ‰¾ã€‚

> æ¥ä¸‹æ¥è¿™éƒ¨åˆ†çš„æ¸¸æ ‡éƒ½æ˜¯åŸºäºå¯¹è±¡å­˜å‚¨ç©ºé—´åˆ›å»ºçš„

é€šè¿‡`IDBObjectStore.openCursor()`å³å¯åˆ›å»ºä¸€ä¸ª`IDBCursor`æ¸¸æ ‡å¯¹è±¡ï¼Œè¯¥å‡½æ•°æ¥å—ä¸¤ä¸ª**å¯é€‰**å‚æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºæ¸¸æ ‡æŸ¥è¯¢çš„èŒƒå›´ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªæŸ¥è¯¢çš„é”®å€¼æˆ–è€…`IDBKeyRange`ï¼Œä¸ä¼ æ—¶è®¤ä¸ºè¦æŸ¥è¯¢å…¨éƒ¨æ•°æ®ï¼›ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ¸¸æ ‡çš„ç§»åŠ¨æ–¹å‘ï¼Œå¯ä»¥ä¸ºå¦‚ä¸‹å€¼

-   `next`: è¡¨ç¤ºä¸‹ä¸€é¡¹(é»˜è®¤)
-   `nextunique`: è¡¨ç¤ºä¸‹ä¸€ä¸ªä¸é‡å¤çš„é¡¹(å³é‡å¤çš„åªä¼šéå†ç¬¬ä¸€ä¸ª)
-   `prev`: ä»å°¾å¼€å§‹éå†
-   `prevunique`: ä»å°¾å¼€å§‹éå†ä¸é‡å¤

è¯¥å‡½æ•°çš„ç»“æœåŒæ ·æ˜¯è¿”å›ä¸€ä¸ª`IDBRequest`å¯¹è±¡ã€‚

```js
// å‡è®¾åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹çš„store
const store = database.createObjectStore('xxx', { keyPath: 'x' })

// éšåæˆ‘ä»¬åœ¨äº‹åŠ¡ä¸­æ’å…¥è¿™æ ·ä¸¤æ¡æ•°æ®(çœç•¥äº‹åŠ¡æ“ä½œ)
store.add({
    x: [1, 2, 3],
    y: 2,
    z: 3
})
store.add({
    x: 2,
    y: 3,
    z: 4
})

store.add({
    x: 6,
    y: 6
})

// åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å…¨éƒ¨æ•°æ®çš„æ¸¸æ ‡
const request = store.openCursor()

request.onsuccess = ({ target: { result } }) => result
```

è°ƒç”¨åä¼šè¿”å›ä¸€ä¸ª`IDBCursorWithValue`å¯¹è±¡(`IDBCursor`å¯¹è±¡çš„å­ç±»)ï¼Œç»“æ„å¦‚ä¸‹ï¼š

![create a cursor](../imgs/create%20a%20cursor.jpg)
![a snapshot of current store](../imgs/use%20a%20cursor'store.jpg)

å¯ä»¥çœ‹åˆ°æ¸¸æ ‡ç±»ä¼¼äºä¸€ä¸ªè¿­ä»£å™¨ï¼Œéœ€è¦é€šè¿‡ä¸æ–­çš„è¿­ä»£æ¥è·å–ä¸‹ä¸€æ¡æ•°æ®çš„å€¼ã€‚åœ¨å½“å‰æ¸¸æ ‡ä¸­ï¼Œ`value`è¡¨ç¤ºå½“å‰çš„æ•°æ®ï¼Œ`key`è¡¨ç¤ºå½“å‰æ¸¸æ ‡æŸ¥è¯¢çš„é”®å€¼ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé‚£ä¹ˆå…¶å’Œ`primaryKey`ä¸€æ ·æ˜¯`keyPath`çš„é”®å€¼ã€‚

> æ³¨æ„`IDBObjectStore.openCursor()`çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ**å½“ä½ ä¸ä½¿ç”¨`IDBRange`å¯¹è±¡æ—¶ï¼Œå…¶ä¸ºå½“å‰çš„`keyPath`(ä½¿ç”¨é€šè¿‡`IDBObjectStore`åˆ›å»ºçš„æ¸¸æ ‡æ—¶)æˆ–ç´¢å¼•çš„`key`(ä½¿ç”¨é€šè¿‡ç´¢å¼•åˆ›å»ºçš„æ¸¸æ ‡æ—¶)çš„å€¼**ï¼Œæ–‡æ¡£å†™çš„æ˜¯é”®ï¼Œä»»æ„ç†è§£ä¸ºé”®åï¼Œç„¶è€Œä¸æ˜¯

å½“æˆ‘ä»¬ä¸º`IDBObjectStore.openCursor()`æŒ‡å®šç¬¬ä¸€ä¸ªå‚æ•°æ—¶ï¼Œå®ƒç›¸å½“äºå®šå‘æŸ¥æ‰¾ä¸€ä¸ªå€¼(ç±»ä¼¼äºç´¢å¼•çš„`get()`)

```js
// æ„æ€å°±æ˜¯æŸ¥æ‰¾ keyPathä¸º6çš„å€¼
const request = store.openCursor(6)

request.onsuccess = ({ target: { result } }) => result
```

ç»§ç»­éå†æˆ‘ä»¬éœ€è¦è°ƒç”¨`IDBCursorWithValue.continue()`æ–¹æ³•ï¼Œè°ƒç”¨åï¼Œä¸‹ä¸€æ¬¡ä¸ªæ•°æ®çš„ç»“æœä¼šåŒæ ·é€šè¿‡åˆšæ‰çš„äº‹ä»¶è®¢é˜…è¿›è¡Œé€šçŸ¥ï¼Œç›´åˆ°éå†å®Œæ¯•æ—¶ï¼Œ`event.target.result`ä¼šè¿”å›`null`:

```js
// åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å…¨éƒ¨æ•°æ®çš„æ¸¸æ ‡
const request = store.openCursor()

request.onsuccess = ({ target: { result } }) => {
    // ...do something

    // ç»§ç»­éå†
    result?.continue()
}
```

`IDBCursorWithValue.continue()`æ–¹æ³•ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªé”®å€¼ï¼Œæ¥åœ¨ä¸‹æ¬¡è¿­ä»£æ—¶è·³è¿‡å…¶ä»–å€¼ç›´æ¥æŸ¥æ‰¾æŒ‡å®šå€¼ï¼Œä½†æ˜¯æ³¨æ„ä¸€æ—¦æŸ¥æ‰¾åˆ°åï¼Œå†æ¬¡æŸ¥æ‰¾å°±ä¼šæŠ¥é”™ï¼š

```js
// åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å…¨éƒ¨æ•°æ®çš„æ¸¸æ ‡
const request = store.openCursor()

request.onsuccess = ({ target: { result } }) => {
    console.log(result)

    // ç›´æ¥æŸ¥æ‰¾ keyPath å€¼ä¸º 6 çš„æ•°æ®(åœ¨ä¸Šå›¾çš„ç¬¬äºŒä¸ªä½ç½®)
    result?.continue(2)
}
```

ä¸Šè¿°çš„ç»“æœéå†å‡ºæ¥åº”è¯¥ä¼šæ‰“å°ä¸¤æ¬¡ï¼Œåœ¨ç¬¬ä¸‰æ¬¡éå†æ—¶æŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æ‰¾åˆ°å¯¹åº”å€¼ä¸º`keyPath: 2`çš„æ•°æ®ï¼š

![use a continue](../imgs/use%20continue.png)

å¦‚æœä½ æƒ³æ¯æ¬¡è¿›è¡Œå›ºå®šé—´éš”çš„è¿­ä»£ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨`IDBCursorWithValue.advance(count)`ï¼Œå®ƒçš„æ•ˆæœå’Œ`IDBCursorWithValue.continue()`ä¸€æ ·ï¼Œä¸è¿‡å…¶å¯ä»¥ä¼ å…¥ä¸€ä¸ªæ¯æ¬¡è¿­ä»£çš„è·¨åº¦ä½œä¸ºå‚æ•°ï¼š

```js
const request = store.openCursor()

request.onsuccess = ({ target: { result: cursor } }) => {
    // æ¯æ¬¡è¿­ä»£è·³è¿‡1ä¸ª
    // å¦‚ç¬¬ä¸€æ¬¡è®¿é—®ç¬¬ä¸€ä¸ªï¼Œç¬¬äºŒæ¬¡è®¿é—®ç¬¬ä¸‰ä¸ª
    cursor?.advance(2)
}
```

ç”±äºé€šè¿‡æ¸¸æ ‡æŸ¥è¯¢åˆ°çš„å½“å‰æ•°æ®éƒ½æ˜¯åªè¯»çš„ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¿®æ”¹æ•°æ®åº“çš„è¿™æ¡æ•°æ®é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è°ƒç”¨`IDBCursorWithValue.update()`ä¼ å…¥è¦ä¿®æ”¹çš„æ•°æ®å³å¯(åŒæ ·çš„ï¼Œè¯¥æ–¹æ³•è¿”å›ä¿®æ”¹çš„è¯·æ±‚ï¼Œæ‰€ä»¥éœ€è¦äº‹ä»¶å»è®¢é˜…)ã€‚

```js
const request = store.openCursor()

request.onsuccess = ({ target: { result: cursor } }) => {
    // å°†å½“å‰æ¸¸æ ‡æŒ‡å‘æ•°æ®ä¿®æ”¹å€¼ä¸º222
    cursor.update(222)
}
```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥è°ƒç”¨`IDBCursorWithValue.delete()`å»åˆ é™¤è¿™æ¡æ•°æ®ã€‚

[MDN IDBObjectStore.openCursor](https://developer.mozilla.org/zh-CN/docs/Web/API/IDBObjectStore/openCursor)

##### åŸºäºç´¢å¼•åˆ›å»ºçš„æ¸¸æ ‡

åœ¨ç´¢å¼•é›†åˆä¸­æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ç´¢å¼•æ¥æŸ¥æ‰¾æ•°æ®ï¼Œç°åœ¨æˆ‘ä»¬æ„å»ºä¸€ä¸ªå¦‚ä¸‹çš„æ•°æ®åº“ï¼š

```js
// åˆ›å»ºå¯¹è±¡å­˜å‚¨ç©ºé—´(ä¼ªä»£ç )
const store = database.createObjectStore('xxx', { keyPath: 'x' })

// åˆ›å»ºç´¢å¼•(ç´¢å¼•çš„å€¼å¯ä»¥é‡å¤)
store.createIndex('my-index', 'y')

// æ·»åŠ å‡ æ¡æ•°æ®(åæœŸé€šè¿‡äº‹åŠ¡æ·»åŠ çš„å“ˆ)
store.add({
    x: 1,
    y: 1
})
store.add({
    x: 2,
    y: 1
})
store.add({
    x: 3,
    y: 2
})
store.add({
    x: 4,
    y: 3
})
```

é‚£ä¹ˆå…¶åœ¨ä¼šäº§ç”Ÿå¦‚å›¾æ‰€ç¤ºçš„ç´¢å¼•å†…å®¹ï¼š

![index's cursor](../imgs/index%20cursor%20start.png)

ç°åœ¨æˆ‘ä»¬é€šè¿‡ç´¢å¼•æ¥åˆ›å»ºæ¸¸æ ‡æ¥éå†ï¼š

```js
const request = index.openCursor()

request.onsuccess = ({ target: { result: cursor } }) => {
    cursor.continue()
}
```

è¿”å›çš„å•ä¸ªæ¸¸æ ‡æœ‰å€¼å¯¹è±¡ä¸ºï¼š

![index's cursor-with-value](../imgs/index%20cursor-with-value.png)

å¯ä»¥çœ‹åˆ°æ­¤æ—¶`IDBCursorWithValue.key`å¯¹åº”çš„æ˜¯ç´¢å¼•çš„`key`å€¼ã€‚(è¿™åªæ˜¯è®ºè¯äº†ä¸Šé¢å¯¹äº`openCursor()`ç¬¬ä¸€ä¸ªå‚æ•°çš„æè¿°)

é™¤æ­¤ä¹‹å¤–ï¼Œåˆšåˆšæˆ‘ä»¬å¹¶æ²¡æœ‰ä»‹ç»`openCursor()`çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå› ä¸ºåœ¨å¯¹è±¡å­˜å‚¨ç©ºé—´åˆ›å»ºçš„æ¸¸æ ‡æ—¶ï¼Œå…¶é”®å€¼æ˜¯ä¸ä¼šé‡å¤çš„ï¼Œæ‰€ä»¥æ–¹å‘ä¸­çš„`prevunique/nextunique`ä¸¤ä¸ªæ²¡æœ‰æ„ä¹‰ç­‰åŒäº`prev/next`ï¼›ä½†åœ¨é€šè¿‡ç´¢å¼•åˆ›å»ºçš„æ¸¸æ ‡ä¸­ï¼Œå°±å¯èƒ½å­˜åœ¨ç´¢å¼•å€¼é‡å¤çš„æƒ…å†µ(å½“ç„¶ä½ ä¸èƒ½é’»ç©ºå­ï¼Œåœ¨åˆ›å»ºç´¢å¼•æ—¶åˆ›å»ºå…·æœ‰`unique`çš„ç´¢å¼•`key`)ã€‚

ä½¿ç”¨ä¸Šé¢çš„ç´¢å¼•ï¼Œæˆ‘ä»¬æ¥ä½¿ç”¨`nextunique`éå†ä¸€æ¬¡æ¸¸æ ‡ï¼š

```js
const request = index.openCursor(void 0, 'nextunique')

request.onsuccess = ({ target: { result: cursor } }) => {
    cursor.continue()
}
```

ç»“æœå¦‚ä¸‹å›¾ï¼š

![nextunique](../imgs/nextunique.jpg)

å¯ä»¥çœ‹åˆ°å¯¹äºå…·æœ‰ç›¸åŒç´¢å¼•`key`å€¼ï¼Œ`keyPath`å€¼ä¸º`2`çš„æ•°æ®è¢«è·³è¿‡äº†ï¼Œæ²¡æœ‰è¢«éå†åˆ°ã€‚

ç´¢å¼•é™¤äº†å¯ä»¥åˆ›å»ºæ•°æ®å€¼æŒ‡é’ˆå¤–ï¼Œè¿˜å¯ä»¥åˆ›å»ºå•ç‹¬æŸ¥è¯¢æ•°æ®é”®å€¼çš„æŒ‡é’ˆï¼Œé€šè¿‡`IDBIndex.openKeyCursor(range, direction)`æ–¹æ³•(å‚æ•°å’Œä¸Šé¢çš„é‚£ä¸ªä¸€æ ·)å¯ä»¥åˆ›å»ºç”¨äºè¿­ä»£æŸ¥è¯¢æ•°æ®é”®å€¼çš„æŒ‡é’ˆï¼Œæ¯æ¬¡è¿­ä»£éƒ½ä¼šè¿”å›`IDBCursor`å¯¹è±¡ï¼Œè€Œä¸æ˜¯`IDBCursorWithValue`å¯¹è±¡(è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºä¸¤è€…çš„å…³ç³»å°±æ˜¯åè€…å¤šäº†ä¸€ä¸ª`value`å±æ€§):

```js
// è¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„ç´¢å¼•
const request = index.openKeyCursor()

request.onsuccess = ({ target: { result: cursor } }) => {
    cursor.continue()
}
```

è¿­ä»£ç»“æœå¦‚ä¸‹ï¼š

![openKeyCursor](../imgs/open-key-cursor.png)

[MDN IDBIndex.openCursor](https://developer.mozilla.org/zh-CN/docs/Web/API/IDBIndex)

[MDN IDBCursor](https://developer.mozilla.org/zh-CN/docs/Web/API/IDBCursor)

#### æŸ¥è¯¢èŒƒå›´æ§åˆ¶

ä¸Šé¢æˆ‘ä»¬åœ¨ä»‹ç»æŸ¥è¯¢æ—¶æåˆ°ï¼Œ`IDBIndex.getAll()/IDBIndex.getAllKeys()`ä»¥åŠæ¸¸æ ‡åœ¨åˆ›å»ºæ—¶é™¤äº†å¯ä»¥æŒ‡å®šä¸€ä¸ª`IDBKeyRange`å¯¹è±¡æ¥æ§åˆ¶éå†æˆ–æŸ¥è¯¢çš„èŒƒå›´ã€‚

`IDBKeyRange`å¯¹è±¡å¯ä»¥ç”¨æ¥æ§åˆ¶æˆ‘ä»¬æŸ¥è¯¢é”®å€¼çš„ä¸Šè¾¹ç•Œå’Œä¸‹è¾¹ç•Œæˆ–åªæŸ¥è¯¢æŸä¸ªå•ç‹¬çš„é”®å€¼ï¼Œåˆ›å»ºä¸€äº›æ¥æ§åˆ¶ç®€å•é”®å€¼èŒƒå›´çš„èŒƒå›´å¯¹è±¡ï¼Œåœ¨è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶å°†å…¶ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ä¸Šè¿°çš„æ–¹æ³•ä¸­å³å¯ã€‚

å‡å¦‚æˆ‘ä»¬è¦æŒ‡å®šé”®å€¼åªèƒ½åœ¨`A-F`ä¹‹é—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡`IDBKeyRange.bound('A', 'F')`æ–¹æ³•åˆ›å»ºä¸€ä¸ªèŒƒå›´ï¼Œè¯¥æ–¹æ³•è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªæŒ‡å®šäº†ä¸Šè¾¹ç•Œå’Œä¸‹è¾¹ç•Œçš„`IDBKeyRange`å¯¹è±¡ï¼Œå¯ä»¥ä¼ å…¥`4`ä¸ªå‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸‹é¢çš„å±æ€§ï¼Œå…¶ä¼šè¿”å›ä¸€ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼š

![a base key-range](../imgs/a%20base%20keyrange.png)

å®ƒçš„`4`ä¸ªå±æ€§åˆ†åˆ«è¡¨ç¤ºï¼š

-   `lower`: é”®å€¼çš„ä¸‹ç•Œ
-   `upper`: é”®å€¼çš„ä¸Šç•Œ
-   `lowerOpen`: é”®å€¼èŒƒå›´ä¸­æ˜¯å¦**ä¸åŒ…å«**å½“å‰ä¸‹è¾¹ç•Œçš„å€¼ï¼Œé»˜è®¤ä¸º`false`ï¼Œ
-   `upperOpen`: é”®å€¼èŒƒå›´ä¸­æ˜¯**ä¸å¦åŒ…**å«å½“å‰ä¸Šè¾¹ç•Œçš„å€¼ï¼Œé»˜è®¤ä¸º`false`

é™¤äº†ä¸Šé¢çš„`IDBKeyRange.bound()`å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºæ›´ç»†ç²’çš„èŒƒå›´ï¼š

-   `IDBKeyRange.only()`ï¼šæ¥æ”¶å•ä¸ªé”®å€¼ä½œä¸ºå‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ªèŒƒå›´å¯¹è±¡ã€‚
-   `IDBKeyRange.lowerBound(name,boolean)`ï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰ä¸‹è¾¹ç•Œçš„èŒƒå›´å¯¹è±¡ã€‚æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºä¸‹è¾¹ç•Œå€¼ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºæ˜¯å¦**ä¸åŒ…å«**è¿™ä¸ªä¸‹ç•Œå€¼ã€‚(è¿™æ ·åˆ›å»ºå‡ºæ¥çš„èŒƒå›´å¯¹è±¡é»˜è®¤ä¸åŒ…å«ä¸Šç•Œå€¼)

-   `IDBKeyRange.upperRange(nameï¼Œboolean)`ï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰ä¸Šè¾¹ç•Œçš„èŒƒå›´å¯¹è±¡ã€‚æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºä¸Šè¾¹ç•Œå€¼ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºæ˜¯å¦**ä¸åŒ…å«**è¿™ä¸ªä¸Šç•Œå€¼ã€‚(è¿™æ ·åˆ›å»ºå‡ºæ¥çš„èŒƒå›´å¯¹è±¡é»˜è®¤ä¸åŒ…å«ä¸Šç•Œå€¼)

`IDBKeyRange`å¯¹è±¡å¯ä»¥ç”¨äºæ§åˆ¶ä¸€ä¸ªäº›ç®€å•å€¼çš„èŒƒå›´ï¼Œå‡å¦‚æ­¤æ—¶æœ‰ä»¥ä¸‹çš„å¯¹è±¡å­˜å‚¨ç©ºé—´å’Œç´¢å¼•ï¼š

```js
// åˆ›å»ºå¯¹è±¡å­˜å‚¨ç©ºé—´(ä¼ªä»£ç )
const store = database.createObjectStore('xxx', { keyPath: 'x' })

// åˆ›å»ºç´¢å¼•(ç´¢å¼•çš„å€¼å¯ä»¥é‡å¤)
store.createIndex('my-index', 'y')

// æ·»åŠ å‡ æ¡æ•°æ®(åæœŸé€šè¿‡äº‹åŠ¡æ·»åŠ çš„å“ˆ)
store.add({
    x: 1,
    y: 1
})
store.add({
    x: 2,
    y: 1
})
store.add({
    x: 3,
    y: 2
})
store.add({
    x: 4,
    y: 3
})
```

æˆ‘ä»¬è®¾ç½®æŸ¥è¯¢å½“å‰ç´¢å¼•ä¸­ç´¢å¼•`key`å€¼åœ¨`3-4`(åŒ…å«è¾¹ç•Œçš„å€¼)ï¼š

```js
const range = IDBKeyRange(3, 4)

// çœç•¥ä¸­å›¾çš„äº‹åŠ¡æ“ä½œï¼Œå‡è®¾æˆ‘ä»¬ç›´æ¥è·å–åˆ°äº†å¯¹è±¡å­˜å‚¨ç©ºé—´
const index = store.index('my-index')
index.getAll(range)
```

é‚£ä¹ˆæŸ¥è¯¢çš„ç»“æœä¸º:

![search with range](../imgs/search%20with%20range.jpg)

[MDN IDBKeyRange](https://developer.mozilla.org/zh-CN/docs/Web/API/IDBKeyRange)

## å®é™…åº”ç”¨ä¸­çš„é—®é¢˜

### å¤šé¡µé¢å¹¶å‘é—®é¢˜

`IndexedDB`æä¾›çš„æ˜¯è¯·æ±‚å¼çš„å¼‚æ­¥`API`ï¼Œæ‰€ä»¥æœ‰æ—¶ä¼šå­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œå½“ä¸¤ä¸ªä¸åŒçš„æ ‡ç­¾é¡µæ‰“å¼€äº†åŒä¸€ä¸ªé¡µé¢ï¼Œä¸”ä¸€ä¸ªé¡µé¢è¯•å›¾æ›´æ–°ä¸€ä¸ªæ›´é«˜çº§ç‰ˆæœ¬çš„æ•°æ®åº“æ—¶å°±ä¼šå‘ç”Ÿå†²çªï¼Œåˆé€‚çš„å¤„ç†è¿™ä¸ªé—®é¢˜éå¸¸é‡è¦ã€‚

ä¸€èˆ¬æ¥è¯´ç‰ˆæœ¬çš„å‡è¿æ ‡å¿—ç€æ•´ä¸ªé¡µé¢çš„é‡æ–°å‘å¸ƒï¼Œæ­¤æ—¶å¦‚æœç”¨æˆ·ä»æœ‰è€é¡µé¢å­˜æ´»ï¼Œé‚£ä¹ˆæ›´é«˜çº§ç‰ˆæœ¬é¡µé¢çš„`IndexedDB`å°±ä¼šè§¦å‘[`blocked`](https://developer.mozilla.org/en-US/docs/Web/API/IDBOpenDBRequest/onblocked)äº‹ä»¶é˜»æ­¢æœ¬æ¬¡ç‰ˆæœ¬å‡è¿ã€‚æ‰€ä»¥é€šè¿‡è®¢é˜…è¯¥äº‹ä»¶æ¥é€šçŸ¥ç”¨æˆ·å…³é—­è€é¡µé¢ç„¶ååœ¨é‡è½½å½“å‰é¡µé¢è¿™æ‰æ˜¯ä¸€ä¸ªåˆç†çš„å¤„ç†ã€‚å¯¹äºè€é¡µé¢ï¼Œå¦‚æœæœ‰å…¶ä»–é¡µé¢åœ¨å‡è¿æ›´é«˜çº§çš„æ•°æ®åº“ï¼Œé‚£ä¹ˆä¼šæ”¾å‡º`versionchange`äº‹ä»¶ï¼Œæ­¤æ—¶ä½ éœ€è¦åœ¨äº‹ä»¶ä¸­å…³é—­æ•°æ®åº“(è°ƒç”¨[`IDBDatabase.close()`](https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/close)æ–¹æ³•å°†å½“å‰çš„æ•°æ®åº“å…³é—­ï¼Œæ•°æ®åº“ä¸ä¼šç«‹å³å…³é—­ï¼Œä¼šæ‰§è¡Œå®Œå½“å‰çš„äº‹åŠ¡)ï¼Œå¹¶é€šçŸ¥ç”¨æˆ·é‡æ–°åŠ è½½è¯¥é¡µç ã€‚

```js
const request = indexedDB.open('xxx', 1)

// åœ¨æ‰“å¼€æ•°æ®åº“æ—¶ï¼Œè®¢é˜…è¯¥äº‹ä»¶ï¼Œå¥½åœ¨ä»¥ä¸Šæƒ…å†µæ—¶é€šçŸ¥ç”¨æˆ·
request.onblocked = () => {
    // é€šçŸ¥ç”¨æˆ·å…³é—­
}

request.onsuccess = ({ target: { result: database } }) => {
    // å½“å‰ç½‘é¡µçš„å…¶ä»–æ ‡ç­¾é¡µåœ¨å‡è¿æ•°æ®åº“ç‰ˆæœ¬æ—¶ï¼Œå…³é—­å½“å‰é¡µé¢çš„æ•°æ®åº“ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
    database.onversionchange = () => {
        database.close()

        // ...æç¤ºç”¨æˆ·
    }
}
```

### åŒæ­¥åŒ–æ“ä½œ

åº•å±‚çš„`IndexedDB API`åŸºæœ¬ä¸Šæ˜¯åŸºäºå¼‚æ­¥å®ç°çš„ï¼Œåœ¨å®é™…ä»£ç ä¹¦å†™ä¸­éå¸¸éš¾çœ‹ä¸”ä¸ä¾¿äºé˜…è¯»ï¼Œä½ å¯ä»¥åŠ¨æ‰‹å°†å…¶æ”¹é€ ä¸º`Promise`ç‰ˆæœ¬ï¼Œä½ å¯ä»¥æŸ¥çœ‹æˆ‘çš„[ç®€å•æ”¹é€ ç‰ˆæœ¬](./easy-idb.js)ï¼Œå½“ç„¶æˆ‘è¿˜æ˜¯æ¨èä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿçš„åº“â€”[idb](https://www.npmjs.com/package/idb)ï¼Œå®ƒçš„ç”¨æ³•åŸºæœ¬ä¸Šä¸åŸæ¥ä¸€è‡´ï¼Œæ‰€ä»¥ä½ å¿…é¡»è¦æ‡‚`IndexedDB`çš„æ“ä½œï¼æˆ–è€…ä¸€ä¸ªæ›´ç®€æ´çš„ç‰ˆæœ¬â€”[idb-keyval](https://www.npmjs.com/package/idb-keyval)

### åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨(Work with Worker)

`indexedDB`é™¤äº†åœ¨å¸¸è§„çº¿ç¨‹ä½¿ç”¨ä¹‹å¤–è¿˜å¯ä»¥åœ¨å•ç‹¬çš„`Web Worker`çº¿ç¨‹ä¸­ä½¿ç”¨ï¼Œè¿›è¡Œç‹¬ç«‹è¿ç®—ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ“ä½œã€‚

---

Reference

1. `Javascript` é«˜çº§æ•™ç¨‹
2. [MDN IndexedDB](https://developer.mozilla.org/en-US/docs/Tools/Storage_Inspector/IndexedDB)
3. [MDN IndexedDB åŸºç¡€æ¦‚å¿µ](https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API/Basic_Concepts_Behind_IndexedDB)
4. [MDN IDBObjectStore](https://developer.mozilla.org/zh-CN/docs/Web/API/IDBObjectStore#createindex)
5. [A quick but complete guide to IndexedDB and storing data in browsers](https://medium.com/free-code-camp/a-quick-but-complete-guide-to-indexeddb-25f030425501)
6. [Improve your cache using the hated IndexedDB](https://blog.canellariccardo.it/improve-your-cache-using-the-hated-indexeddb-adbd0f65cb7c)
7. [Can I use IndexedDB](https://caniuse.com/?search=IndexedDB)
